# 設計ドキュメント

## 目的と範囲
- 目的: `raw_markdowns` に保管されたMarkdownを、Next.js 15 App Router の構造に準拠した `src/app/docs` 配下へ移行し、学習ドキュメントとして公開する。
- 範囲: 章・節ごとのページ分割、Front Matter 付与、ルーティング/ナビゲーション/検索との統合、既存デモコンテンツの置換。アプリ本体の挙動変更は行わない。
- 非範囲: コンテンツ本文の編集、リライト、用語統一。

## 全体アーキテクチャ
- フレームワーク: Next.js 15（App Router）。
- 表示エンジン: Markdoc ベースのレンダリング（`src/components/DocsLayout.tsx`、`src/lib/sections.ts`、`src/markdoc/*`）。
- コンテンツ格納: `src/app/docs/<slug>/page.md` として各ページを配置し、Front Matter（`title`, `description`）を付与。
- 検索連携: `src/markdoc/search.mjs` の FlexSearch インデックスにより、ビルド時に `src/app/docs` を走査して登録される。

## 情報設計（IA）とURL設計
- 章（H1）単位を基本ページ単位とし、必要に応じて節（H2, H3）はページ内目次（Table of Contents）で表現。
- ルートパス: `/docs/<section>/<page>` 形式（既存のデモと同形式）。
- スラッグ命名:
  - ページフォルダ名はタイトルからスラッグ化（ASCIIの `kebab-case`）。
  - 日本語タイトルはローマ字化（可能なら）→英数字以外除去→`-` 区切り。重複時は連番サフィックス（`-2`, `-3`）。
  - タイトル変更に伴うURL変更は極力避けるため、初回移行時のスラッグを固定し、以降の変更は慎重に扱う。

## ディレクトリ構成（例）
```
src/app/docs/
  react-pokemon-zukan-intro/
    page.md            # title/description をFront Matterで定義
  environment-setup/
    page.md
  routing-and-detail-view/
    page.md
  ...
```

## 移行ポリシー
- 原本不改変: `raw_markdowns` は読み取り専用。移行物は `src/app/docs` に新規作成。
- 分割ルール:
  - 1ファイル内に複数のH1があれば、H1ごとにページを分割して別フォルダに配置。
  - 先頭H1はページの `title` として使用。`description` はH1直後の最初の段落から先頭150文字程度を要約（改行・装飾を除去）。
- Front Matter:
  - 必須: `title`（文字列）、`description`（文字列）。
  - 任意: `order`（数値、ナビゲーション整列の補助。明示しない場合はアルファベット順）。
- 内部リンク:
  - 相対リンクは移行後のスラッグに合わせて更新（設計上は自動変換方針）。
  - 画像/ファイル参照がある場合は `src/images` など静的資産へ移設、またはページ同階層に `assets/` を作成して参照。

## レンダリング要件の適合
- Markdown構文: 見出し、段落、リスト、強調、リンク、画像、コードブロックを標準レンダリング。
- コードブロック: 言語ヒントがあれば保持。改行・インデントは忠実に表示。
- タイトル反映: Front Matter の `title` を `DocsHeader` と `<title>` に反映（既存実装に準拠）。
- 目次: `src/lib/sections.ts` による H2/H3 抽出でサイド目次を生成。

## ナビゲーション統合
- 既存のデモと同等の形式でサイドナビに新規ページを列挙。
- 並び順: デフォルトはフォルダ名昇順。必要に応じて `order` により制御。
- 以前のデモフォルダは削除して置換し、リンク切れがないことを確認。

## 検索インデックス統合
- ビルド時に `src/markdoc/search.mjs` が `src/app/docs` を走査し、Front Matter の `title` と本文テキストをFlexSearchへ登録。
- 新規ページ追加後は `npm run build` または開発サーバのホットリロードで検索対象へ反映。

## マイグレーション手順（高レベル）
1. 解析: `raw_markdowns` 直下および配下フォルダの `.md` を列挙し、各ファイルのH1/H2を抽出。
2. 分割計画: H1単位のページ境界を決定し、各ページのスラッグ案と `title`/`description` を生成。
3. 出力: `src/app/docs/<slug>/page.md` を作成し、Front Matter と本文（該当H1配下の内容）を書き出し。
4. リンク補正: 相対リンクを新スラッグに合わせて置換。画像等のアセットを所定パスへコピーしパスを更新。
5. 置換: 既存デモフォルダを削除（リポジトリ管理下）。
6. 検証: `npm run dev` でビルド警告/エラーがないこと、ナビ/検索/目次が機能することを確認。

## エラーハンドリングと境界条件
- 同名スラッグ衝突: 末尾に `-2`, `-3` を付与して回避（衝突一覧を出力）。
- タイトル欠落: ファイル名から仮タイトルを生成し、`[Untitled]` を付与。
- 説明文欠落: 最初の段落がない場合は空文字を設定。
- 重いファイル（長大Markdown）: 分割後も1ページが過大なら、H2での分割を追加検討（再設計対象）。

## 品質チェック
- ビルド/型: `npm run build` でエラーなし。
- Lint: `npm run lint` でエラーなし（docs配下のMarkdownは対象外だが、mdレンダリングに伴うReact/TS部分へ影響がないこと）。
- 参照整合: 404リンクがないこと（内部リンク・画像）。

## ロールバック戦略
- マイグレーション生成物は新規追加のため、安全にリバート可能。
- デモ削除は単一コミットでまとめ、必要に応じて復元可能にする。

## 今後の拡張（参考）
- 自動スクリプト化: NodeスクリプトでH1分割/Front Matter付与/スラッグ生成/リンク補正を自動化。
- l10n: 多言語化に向け、`src/app/<locale>/docs` 構造への一般化を想定。
- メタデータ拡張: `keywords`, `lastUpdated`, `authors` などのFront Matter項目を追加。
